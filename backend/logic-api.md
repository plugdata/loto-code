อธิบายโครงสร้างและลำดับการทำงานของ Member Card API
โปรเจกต์นี้เป็นระบบ API สำหรับจัดการบัตรสมาชิก (Member Card) ที่เน้นความเรียบง่ายแต่มีประสิทธิภาพสูง โดยใช้เทคโนโลยีสมัยใหม่บน Node.js

1. เทคโนโลยีที่ใช้ (Tech Stack)
Framework: ใช้ Hono (v4.6) ซึ่งเป็น Web Framework ที่เน้นความเร็วสูงและรองรับหลายสภาพแวดล้อม (ในที่นี้ใช้คู่กับ Node.js)
Database: ใช้ SQLite ผ่าน Prisma ORM (v6.3) ทำให้จัดการฐานข้อมูลได้ง่ายผ่าน Object แทนการเขียน SQL โดยตรง
Authentication: ใช้ JWT (JSON Web Token) และ bcryptjs สำหรับการเข้ารหัสรหัสผ่านและการยืนยันตัวตน
Documentation: มีระบบ Swagger UI สำหรับตัวอย่างคำสั่ง API และทดสอบใช้งานผ่าน Browser

2. โครงสร้างโฟลเดอร์ (Folder Structure)
src/index.js: จุดเริ่มต้นของเซิร์ฟเวอร์ (Entry Point) ใช้สำหรับตั้งค่า App และ Middleware ต่างๆ
src/db/: จัดการการเชื่อมต่อกับฐานข้อมูล (Prisma Client)
src/middlewares/: โค้ดที่ทำงานก่อนถึง Route เช่น การตรวจสอบความเป็นเจ้าของ Token (Auth Middleware)
src/routes/: กำหนดเส้นทาง URL (Endpoints) แยกฐานตามฟีเจอร์ เช่น /auth, /products, /purchases
src/services/: หัวใจของระบบ เป็นส่วนที่เก็บ Business Logic และการติดต่อกับฐานข้อมูล (Prisma Queries)
prisma/schema.prisma: ไฟล์กำหนดโครงสร้างตารางในฐานข้อมูล (10 ตาราง)

3. รูปแบบสถาปัตยกรรม (Architecture Pattern)
ระบบใช้โครงสร้างแบบแบ่งชั้น (Layered Architecture) เพื่อให้ง่ายต่อการดูแลรักษา:

Client: ส่ง Request มาที่ API
Routes: รับ Request -> ตรวจสอบข้อมูลเบื้องต้น -> เรียกใช้งาน Service
Services: ประมวลผลลอจิก (Logic) เช่น การคำนวณยอด, การตรวจสอบเงื่อนไข -> ติดต่อกับ Prisma (DB)
Database: บันทึกหรือดึงข้อมูลจาก SQLite
4. ความสัมพันธ์ของข้อมูล (Data Models)
ระบบมีการเก็บข้อมูลหลักๆ ดังนี้:

User/Customer: ผู้ใช้งานและลูกค้า
Product: สินค้าที่มีการจำกัดจำนวนการซื้อ = เลขอั้นที่ซื้อได้ (Purchase Limit)
Coupon: คูปองส่วนลดที่มีสถานะการใช้งาน = รหัสส่วนลด
Purchase: การซื้อขาย ซึ่งจะเชื่อมโยงกับสินค้าหลายอย่าง (Purchase Items) และคูปอง = การซื้อขาย หวย -> เลขที่ซื้อ -> จำนวนเงิน -> รหัสส่วนลด -> วันที่ซื้อ -> สถานะการซื้อ -> ยอดรวม
5. รายละเอียด API และลอจิกที่สำคัญ
การยืนยันตัวตน (/auth)
Login: ตรวจสอบ username/password -> สร้าง JWT (Token) -> เก็บ Token ไว้ใน HTTP-only Cookie เพื่อความปลอดภัยสูง (ป้องกันการดึงข้อมูลจาก JS ฝั่ง Client)
ระบบการซื้อสินค้า (/purchases) - เป็นส่วนที่ซับซ้อนที่สุด
เมื่อมีการสั่งซื้อ ระบบจะใช้ Database Transaction (ต้องสำเร็จทุกขั้นตอน ถ้าติดขัดที่ขั้นตอนใดขั้นตอนหนึ่งจะยกเลิกทั้งหมด) ดังนี้:

ตรวจสอบคูปอง: มีอยู่จริงไหม? ใช้ไปหรือยัง? หมดอายุหรือยัง? -> ตรวจสอบ หวย -- setting ปรับให้เข้ากับ api  -- 
ตรวจสอบสินค้า: มีการจำกัดจำนวนซื้อไหม?  -->ตรวจสอบเลขอั้น -->จำนวนเลขที่ สั่งซื้อ -->ปริมาณเกินโควต้าที่เหลืออยู่ไหม? สต็อกพอไหม?
บันทึกการซื้อ: สร้าง Record ในตาราง Purchase
ตัดสต็อก: ลดจำนวนสินค้าในสต็อกและบันทึกรายละเอียดสินค้าที่ซื้อ (PurchaseItems)
อัปเดตคูปอง: เปลี่ยนสถานะคูปองเป็น 'used'
จัดการส่วนแบ่ง: คำนวณยอด PercentAllocation สำหรับผู้ใช้งาน -- สรุปยอด ผู้ใช้งาน หลัก --
6. รูปแบบมาตรฐานของ Service
ในการพัฒนาฟีเจอร์ทั่วไป (CRUD) จะใช้รูปแบบเดียวกันทั้งหมด:

findAll(): ดึงข้อมูลทั้งหมด
findOne(id): ดึงข้อมูลตาม ID (ถ้าไม่เจอจะ Error 404)
create(data): สร้างข้อมูลใหม่
update(id, data): อัปเดตข้อมูล (ตรวจสอบก่อนว่ามี ID นี้อยู่จริง)
remove(id): ลบข้อมูล
7. ข้อมูลการตั้งค่า (Configuration)
สามารถตั้งค่าผ่านไฟล์ .env ได้แก่:

PORT: พอร์ตที่รัน (เริ่มต้น 3000)
JWT_SECRET: รหัสลับสำหรับสร้าง Token
DATABASE_URL: ที่อยู่ไฟล์ฐานข้อมูล SQLite
สรุป: เป็นระบบ API ที่มีการออกแบบที่ชัดเจน แบ่งสัดส่วนของโค้ดตามหน้าที่ (Separation of Concerns) และใช้ระบบ Transaction เพื่อรับประกันความถูกต้องของข้อมูลในการทำรายการสำคัญครับ

*** หลักการ role -> admin  -> user -> customer

บทบาท admin -> สามารถจัดการ setting -> ต่างๆ ได้ทั้หมด -> ยอดรวมของระบบ  -> สามารถ add user ได้ -> ยอดเงินของ user ทั้งหมด -> ลดหักเปอร์เซ็น -> และแจ้งยอดที่ได้ 
บทบาท user -> สามารถคีย์หวย -> ซื้อหวย ->  ยอดเงินของ user เฉพาะของตัวเอง -> ยอดเงินสั้งซื้อของ custommer -> ยอดเงินที่ต้องจ่ายให้เจ้ามือ  -> สามารถ add customer ได้ 
บทบาท customer -> เก็บชื้อและ สถานะ ส่วนลดคูปอง ได้  